# 签到系统核心机制与操作指南

本文档详细说明了年会抽奖系统中“签到模块”的数据同步机制、重置逻辑以及免登录关联原理，旨在帮助管理员理解系统如何确保本地大屏与云端数据库的一致性。

## 1. 核心问题与解决方案

### 问题现象

在之前的版本中，管理员在“设置面板”点击“重置数据”后，发现：

1.  本地显示的统计数据归零。
2.  但刷新页面或重新打开“签到大屏”后，旧的签到记录依然存在。
3.  系统提示“数据库签到没有与本地关联”。

### 根本原因

这是一个典型的**端云分离**问题：

- **本地重置**：仅清除了浏览器缓存（Local Storage）。
- **云端残留**：Supabase 数据库中的签到记录未被删除。
- **读取优先级**：签到大屏（Display Page）被设计为优先读取云端实时数据，因此“删除本地”对它无效。

### 解决方案

我们实施了**强制同步机制**：
现在，无论是“全局重置”还是“导出页重置”，系统都会执行以下双重操作：

1.  🔥 **云端指令**：调用 `clearCheckInRecordsForEvent` API，直接从数据库物理删除当前活动的签到记录。
2.  🧹 **本地清理**：随后清除浏览器的 Local Storage 缓存。

---

## 2. 免登录关联机制 (Unauthenticated Association)

您可能会问：**"我都没有登录账号，系统怎么知道可以删除哪个数据库的记录？它是通过 IP 还是浏览器识别我的？"**

答案是：**我们采用混合策略，按优先级智能关联活动。**

### 关联优先级（从高到低）

```
┌─────────────────────────────────────────────────────────────┐
│           活动关联优先级 (Event Association Priority)         │
├─────────────────────────────────────────────────────────────┤
│  1️⃣ 登录用户 → 使用用户创建/关联的项目                         │
│  2️⃣ URL参数  → ?event=xxx 指定的活动ID                        │
│  3️⃣ 浏览器缓存 → LocalStorage 存储的上次操作活动               │
│  4️⃣ 全局活动 → 数据库中 status='active' 的活动                 │
└─────────────────────────────────────────────────────────────┘
```

### 工作原理详解

| 策略           | 触发条件                             | 适用场景           |
| -------------- | ------------------------------------ | ------------------ |
| **登录用户**   | 用户已登录管理员账号                 | 多项目管理场景     |
| **URL参数**    | 访问 `/?event=xxx`                   | QR码分享、直接链接 |
| **浏览器缓存** | LocalStorage 有 `luck_last_event_id` | 同一浏览器再次访问 |
| **全局活动**   | 数据库有 `status='active'` 的活动    | 首次访问、现场大屏 |

### 持久化机制

- 当用户**手动切换项目**或**系统自动关联**时，活动ID会被保存到 `localStorage`。
- 下次访问时，即使未登录，系统也会优先使用缓存的活动。
- 重置数据时会同时清除云端记录和本地缓存。

### 结果

即使您只是在本地打开浏览器（未登录管理员账号），系统会智能匹配：

1. 优先检查URL是否指定了活动
2. 然后检查是否有上次操作的缓存
3. 最后使用当前正在进行的全局活动

当您点击"重置"时，系统就知道："哦，用户想重置的是这个活动"，从而准确地执行数据库清理。

---

## 3. 页面导航优化

为了适应年会现场的操作习惯，我们调整了页面跳转逻辑：

- **旧逻辑**：签到大屏 -> 返回 -> 项目列表页 -> (未登录) -> 强制跳转登录页。
  - _痛点：现场操作人员误触返回后，被迫面对登录框，中断演示。_
- **新逻辑**：签到大屏 -> 返回 -> **抽奖主页 (Home)**。
  - _优势：构成了 `抽奖 <-> 签到` 的闭环，无需登录即可在两个大屏页面间无缝切换。_

## 4. 操作建议

### 如何彻底重置测试数据？

1.  打开抽奖主页 (`/`)。
2.  点击右上角设置图标 ⚙️。
3.  由于**免登录系统**已生效，您会看到左侧栏已自动选中了当前活动。
4.  点击右上角的 **“重置数据”** 红色按钮。
5.  在弹窗中确认。
    - _此时系统会同时清空：本地名单、本地奖项、**云端签到记录**。_

### 如何验证？

重置后，直接进入签到大屏 (`/display`)，您会发现：

- 签到人数变回 0。
- 实时动态列表已清空。
- 数据库中的 `luck_check_ins` 表也已被清空。
