# 微信登录 + 工号绑定签到方案分析文档

> 版本: 1.0.0  
> 日期: 2026-01-23  
> 作者: AI Assistant

---

## 目录

1. [方案概述](#1-方案概述)
2. [方案对比分析](#2-方案对比分析)
3. [微信登录方案详细设计](#3-微信登录方案详细设计)
4. [实施复杂度评估](#4-实施复杂度评估)
5. [风险分析](#5-风险分析)
6. [推荐方案](#6-推荐方案)
7. [实施计划](#7-实施计划)

---

## 1. 方案概述

### 1.1 现有方案：企业微信扫码签到

```
用户流程：
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 企业微信扫码 │ ──► │ OAuth 授权  │ ──► │ 自动获取工号 │ ──► │ 定位签到    │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
```

**核心特点**：

- 必须使用**企业微信 APP** 扫码
- 员工信息（工号、姓名、部门）由企业微信自动提供
- 无需用户手动输入任何信息

### 1.2 新方案：微信登录 + 工号绑定

```
用户流程：
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 微信扫码登录 │ ──► │ 获取微信 ID │ ──► │ 输入工号绑定 │ ──► │ 身份验证    │ ──► │ 定位签到    │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
                                              ▲
                                              │ 首次需要，后续自动关联
```

**核心特点**：

- 使用普通**微信 APP** 扫码
- 首次需要用户手动输入工号进行绑定
- 后续扫码自动识别身份

---

## 2. 方案对比分析

### 2.1 复杂度对比

| 维度             | 企业微信方案          | 微信登录方案          | 优势方      |
| ---------------- | --------------------- | --------------------- | ----------- |
| **开发复杂度**   | ⭐⭐⭐⭐⭐ 高         | ⭐⭐⭐ 中             | ✅ 微信登录 |
| **配置复杂度**   | ⭐⭐⭐⭐⭐ 高         | ⭐⭐⭐ 中             | ✅ 微信登录 |
| **用户操作**     | ⭐⭐ 简单             | ⭐⭐⭐ 首次复杂       | ✅ 企业微信 |
| **身份验证强度** | ⭐⭐⭐⭐⭐ 企业认证   | ⭐⭐⭐ 自行验证       | ✅ 企业微信 |
| **用户覆盖范围** | ⭐⭐⭐ 限企业微信用户 | ⭐⭐⭐⭐⭐ 全微信用户 | ✅ 微信登录 |

### 2.2 企业微信方案的痛点

1. **配置繁琐**：
   - 需要企业微信管理员权限
   - 创建自建应用、配置可信域名、配置可信 IP
   - 申请敏感信息接口权限（可能需要审批）
2. **开发复杂**：
   - 需要实现完整的 OAuth2.0 流程
   - 需要后端 Edge Function 处理多步 API 调用
   - Token 管理、错误处理较复杂

3. **使用限制**：
   - 必须安装企业微信 APP
   - 必须是企业微信成员
   - 扫码体验可能不如普通微信流畅

4. **测试困难**：
   - 本地开发需要 ngrok 等工具暴露公网
   - 需要真实企业微信账号测试

### 2.3 微信登录方案的优势

1. **配置更简单**：
   - 只需在微信开放平台注册应用
   - 配置回调域名即可
   - 无需申请敏感信息权限

2. **开发更简单**：
   - OAuth 流程更简单
   - 只获取 openid，不涉及企业敏感信息
   - 更成熟的第三方库支持

3. **覆盖面更广**：
   - 所有微信用户都可使用
   - 无需额外安装 APP

4. **灵活性更高**：
   - 可以自定义验证逻辑
   - 支持外部人员参与（如合作伙伴）

### 2.4 微信登录方案的劣势

1. **首次需要工号绑定**：
   - 用户第一次使用需要手动输入工号
   - 可能存在输错工号的风险
2. **身份验证较弱**：
   - 无法自动获取企业认证信息
   - 需要自行实现工号验证逻辑

3. **需要额外的绑定表**：
   - 数据库需要存储微信 openid 与工号的关联
   - 需要处理解绑、重新绑定等场景

---

## 3. 微信登录方案详细设计

### 3.1 用户流程设计

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                             微信登录签到流程                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                   │
│  ┌─────────────┐                                                                 │
│  │  打开签到页面 │                                                                 │
│  └──────┬──────┘                                                                 │
│         │                                                                         │
│         ▼                                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │ 检查是否在微信内打开?                                                          │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│         │                                                                         │
│    ┌────┴────┐                                                                   │
│    │         │                                                                   │
│    ▼ 是      ▼ 否                                                                │
│  ┌─────────┐ ┌─────────────────┐                                                 │
│  │ 自动授权 │ │ 显示二维码供扫描 │                                                 │
│  └────┬────┘ └────────┬────────┘                                                 │
│       │               │                                                           │
│       └───────┬───────┘                                                           │
│               │                                                                   │
│               ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │ 获取微信 openid                                                                │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│               │                                                                   │
│               ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │ 查询是否已绑定工号?                                                            │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│               │                                                                   │
│    ┌──────────┴──────────┐                                                       │
│    │                     │                                                       │
│    ▼ 已绑定              ▼ 未绑定                                                │
│  ┌─────────────┐     ┌─────────────────────────────────────────────────────────┐ │
│  │ 获取绑定信息 │     │ 显示工号输入页面                                          │ │
│  │ (工号、姓名) │     │ ┌─────────────────────────────────────────────────────┐ │ │
│  └──────┬──────┘     │ │                                                     │ │ │
│         │            │ │  请输入您的工号                                      │ │ │
│         │            │ │  ┌─────────────────────────────────────────────────┐│ │ │
│         │            │ │  │ EMP001                                        ▼││ │ │
│         │            │ │  └─────────────────────────────────────────────────┘│ │ │
│         │            │ │                                                     │ │ │
│         │            │ │  （可选）请输入您的姓名用于验证                       │ │ │
│         │            │ │  ┌─────────────────────────────────────────────────┐│ │ │
│         │            │ │  │ 张三                                          ▼││ │ │
│         │            │ │  └─────────────────────────────────────────────────┘│ │ │
│         │            │ │                                                     │ │ │
│         │            │ │           [ 确认绑定 ]                              │ │ │
│         │            │ └─────────────────────────────────────────────────────┘ │ │
│         │            └─────────────────────────────────────────────────────────┘ │
│         │                     │                                                   │
│         │                     ▼                                                   │
│         │            ┌─────────────────────────────────────────────────────────┐ │
│         │            │ 验证工号是否存在于参与者名单                               │ │
│         │            │ • 成功 → 建立绑定关系，继续签到                           │ │
│         │            │ • 失败 → 提示工号不在名单中                               │ │
│         │            └──────────────────────────┬──────────────────────────────┘ │
│         │                                       │                                 │
│         └───────────────────────────────────────┘                                 │
│                             │                                                     │
│                             ▼                                                     │
│              ┌─────────────────────────────────────────────────────────────────┐ │
│              │ 需要定位?                                                        │ │
│              └─────────────────────────────────────────────────────────────────┘ │
│                             │                                                     │
│                  ┌──────────┴──────────┐                                         │
│                  │                     │                                         │
│                  ▼ 是                  ▼ 否                                      │
│              ┌─────────┐         ┌─────────────┐                                 │
│              │ 获取定位 │         │ 显示确认页面 │                                 │
│              └────┬────┘         └──────┬──────┘                                 │
│                   │                     │                                         │
│                   └──────────┬──────────┘                                         │
│                              │                                                    │
│                              ▼                                                    │
│              ┌─────────────────────────────────────────────────────────────────┐ │
│              │ 确认签到                                                          │ │
│              └─────────────────────────────────────────────────────────────────┘ │
│                              │                                                    │
│                              ▼                                                    │
│              ┌─────────────────────────────────────────────────────────────────┐ │
│              │ ✅ 签到成功！                                                     │ │
│              └─────────────────────────────────────────────────────────────────┘ │
│                                                                                   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 数据库设计

#### 3.2.1 新增绑定表

```sql
-- 微信用户绑定表
CREATE TABLE wechat_bindings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- 微信信息
  openid VARCHAR(100) NOT NULL UNIQUE,        -- 微信 openid（唯一标识）
  unionid VARCHAR(100),                        -- 微信 unionid（跨应用唯一标识，可选）
  nickname VARCHAR(100),                       -- 微信昵称
  headimgurl VARCHAR(500),                     -- 微信头像 URL

  -- 绑定的员工信息
  employee_id VARCHAR(100) NOT NULL,           -- 工号
  employee_name VARCHAR(100) NOT NULL,         -- 姓名
  department VARCHAR(200),                     -- 部门

  -- 绑定状态
  status VARCHAR(20) DEFAULT 'active',         -- active/disabled
  bound_at TIMESTAMPTZ DEFAULT NOW(),          -- 绑定时间

  -- 审计
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- 索引
  CONSTRAINT wechat_bindings_status_check CHECK (status IN ('active', 'disabled'))
);

-- 索引
CREATE INDEX idx_wechat_bindings_openid ON wechat_bindings(openid);
CREATE INDEX idx_wechat_bindings_employee ON wechat_bindings(employee_id);
```

#### 3.2.2 修改签到表

```sql
-- 现有 check_ins 表保持不变
-- 签到记录与 wechat_bindings 通过 employee_id 关联
```

### 3.3 API 设计

#### 3.3.1 微信授权接口

```
GET /api/wechat/qrcode-url?redirect_uri={uri}

Response:
{
  "success": true,
  "data": {
    "qrcode_url": "https://open.weixin.qq.com/connect/qrconnect?...",
    "state": "random_state_string"
  }
}
```

#### 3.3.2 OAuth 回调接口

```
GET /api/wechat/callback?code={code}&state={state}

Response: 302 重定向到前端，携带临时 token
```

#### 3.3.3 获取微信用户信息

```
POST /api/wechat/user-info
Content-Type: application/json

{
  "code": "oauth_code"
}

Response:
{
  "success": true,
  "data": {
    "openid": "oxxxxxxxxxxxxxx",
    "nickname": "微信昵称",
    "headimgurl": "https://...",
    "binding": null  // 如果未绑定则为 null
    // 或者
    "binding": {
      "employee_id": "EMP001",
      "employee_name": "张三",
      "department": "技术部"
    }
  }
}
```

#### 3.3.4 绑定工号接口

```
POST /api/wechat/bindSELECT
Content-Type: application/json

{
  "openid": "oxxxxxxxxxxxxxx",
  "employee_id": "EMP001",
  "employee_name": "张三"  // 可选，用于验证
}

Response:
{
  "success": true,
  "data": {
    "binding_id": "uuid-xxx",
    "employee_id": "EMP001",
    "employee_name": "张三",
    "department": "技术研发中心"
  }
}

// 失败响应
{
  "success": false,
  "error": {
    "code": "EMPLOYEE_NOT_FOUND",
    "message": "工号不在参与者名单中"
  }
}
```

### 3.4 前端页面设计

#### 3.4.1 新增绑定页面状态

```typescript
// types/checkin.ts 扩展

export type CheckInPageState =
  | "loading"
  | "show_qrcode"
  | "authorizing"
  | "binding_required" // 新增：需要绑定工号
  | "binding" // 新增：绑定中
  | "get_location"
  | "confirm"
  | "checking_in"
  | "success"
  | "already_checked"
  | "auth_failed"
  | "error";
```

#### 3.4.2 工号绑定界面设计

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           工号绑定页面                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│    ┌─────────────────────────────────────────────────────────────────┐   │
│    │                                                                   │   │
│    │           ┌─────────────┐                                        │   │
│    │           │  微信头像    │                                        │   │
│    │           │  (从授权获取) │                                        │   │
│    │           └─────────────┘                                        │   │
│    │                                                                   │   │
│    │              微信昵称：小明                                        │   │
│    │                                                                   │   │
│    │    ─────────────────────────────────────────────────────────    │   │
│    │                                                                   │   │
│    │              首次使用需要绑定工号                                  │   │
│    │                                                                   │   │
│    │         ┌───────────────────────────────────────────────┐       │   │
│    │         │  请输入您的工号                                 │       │   │
│    │         │  ┌─────────────────────────────────────────┐  │       │   │
│    │         │  │ 例如: EMP001                          🔍 │  │       │   │
│    │         │  └─────────────────────────────────────────┘  │       │   │
│    │         │                                                │       │   │
│    │         │  请输入您的姓名（用于验证）                      │       │   │
│    │         │  ┌─────────────────────────────────────────┐  │       │   │
│    │         │  │ 例如: 张三                              📝 │  │       │   │
│    │         │  └─────────────────────────────────────────┘  │       │   │
│    │         └───────────────────────────────────────────────┘       │   │
│    │                                                                   │   │
│    │             ┌─────────────────────────────────────┐              │   │
│    │             │       ✓ 确认绑定并签到               │              │   │
│    │             └─────────────────────────────────────┘              │   │
│    │                                                                   │   │
│    │                  绑定后下次扫码将自动识别                          │   │
│    │                                                                   │   │
│    └─────────────────────────────────────────────────────────────────┘   │
│                                                                           │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 实施复杂度评估

### 4.1 企业微信方案 vs 微信登录方案

| 工作项             | 企业微信方案                    | 微信登录方案                     |
| ------------------ | ------------------------------- | -------------------------------- |
| **后台配置**       |                                 |                                  |
| 创建应用           | 企业微信自建应用 (复杂)         | 微信开放平台应用 (简单)          |
| 域名配置           | 可信域名 + 可信 IP              | 仅回调域名                       |
| 权限申请           | 敏感接口权限 (需审批)           | 无需审批                         |
| **后端开发**       |                                 |                                  |
| Edge Function 数量 | 2 个 (wecom-oauth, checkin-api) | 2 个 (wechat-oauth, binding-api) |
| API 调用复杂度     | 高 (3 步获取用户信息)           | 低 (2 步获取 openid)             |
| Token 管理         | 需要 access_token 缓存          | 更简单的 token 管理              |
| **数据库**         |                                 |                                  |
| 新增表             | 无 (复用 participants)          | 1 个 (wechat_bindings)           |
| 数据迁移           | 无                              | 无                               |
| **前端开发**       |                                 |                                  |
| 新增页面           | 无                              | 1 个 (绑定页面/状态)             |
| 修改页面           | CheckInPage.tsx                 | CheckInPage.tsx (更多修改)       |
| **测试**           |                                 |                                  |
| 测试难度           | 高 (需真实企业微信)             | 低 (微信测试号即可)              |

### 4.2 工时估算

| 阶段     | 企业微信方案   | 微信登录方案   |
| -------- | -------------- | -------------- |
| 后台配置 | 2-4 小时       | 1-2 小时       |
| 后端开发 | 8-12 小时      | 6-8 小时       |
| 前端开发 | 4-6 小时       | 6-8 小时       |
| 测试调试 | 4-6 小时       | 2-4 小时       |
| **总计** | **18-28 小时** | **15-22 小时** |

### 4.3 结论：微信登录方案更简单

**节省约 20-30% 的开发时间**，主要原因：

1. ✅ 配置步骤更少
2. ✅ OAuth 流程更简单
3. ✅ 无需处理企业微信特有的 API 复杂性
4. ✅ 测试更方便

---

## 5. 风险分析

### 5.1 微信登录方案的风险

| 风险                   | 影响 | 缓解措施                   |
| ---------------------- | ---- | -------------------------- |
| 用户输错工号           | 中   | 添加工号+姓名双重验证      |
| 代签到（借用他人手机） | 中   | 可添加人脸识别（高级选项） |
| 工号泄露               | 低   | 工号本身不是敏感信息       |
| 微信服务不可用         | 低   | 提供手动签到备选方案       |

### 5.2 风险缓解：工号验证策略

```
验证流程：
1. 用户输入工号
2. 系统检查工号是否在参与者名单中
3. (可选) 要求用户输入姓名，与名单对比
4. 验证通过后建立绑定关系

增强验证（可选）：
- 要求输入手机号后 4 位
- 要求输入部门名称
- 短信验证码确认
```

---

## 6. 推荐方案

### 6.1 推荐：微信登录 + 工号绑定

基于以上分析，**推荐采用微信登录 + 工号绑定方案**，理由如下：

1. **开发成本更低**：减少 20-30% 开发时间
2. **配置更简单**：无需企业微信管理员权限
3. **用户覆盖更广**：所有微信用户都可参与
4. **测试更方便**：可使用微信测试号调试

### 6.2 推荐实施策略

| 阶段           | 策略                |
| -------------- | ------------------- |
| **MVP 版本**   | 工号 + 姓名双重验证 |
| **增强版本**   | 可选添加短信验证码  |
| **高安全版本** | 可选添加人脸识别    |

---

## 7. 实施计划

### 7.1 实施步骤

```
Phase 1: 准备工作 (1 天)
├── [ ] 注册微信开放平台账号
├── [ ] 创建网站应用
├── [ ] 配置回调域名
└── [ ] 获取 AppID 和 AppSecret

Phase 2: 后端开发 (2 天)
├── [ ] 创建 wechat-oauth Edge Function
│   ├── 生成授权 URL
│   ├── 处理 OAuth 回调
│   └── 获取用户 openid
├── [ ] 创建 binding-api Edge Function
│   ├── 查询绑定状态
│   ├── 创建绑定关系
│   └── 验证工号有效性
└── [ ] 创建数据库表 (wechat_bindings)

Phase 3: 前端开发 (2 天)
├── [ ] 修改 CheckInPage.tsx
│   ├── 添加 binding_required 状态
│   ├── 添加工号输入表单
│   ├── 添加验证逻辑
│   └── 保持现有签到流程
└── [ ] 更新类型定义

Phase 4: 测试与上线 (1 天)
├── [ ] 本地测试完整流程
├── [ ] 部署 Edge Function
├── [ ] 部署前端应用
└── [ ] 生产环境验证
```

### 7.2 技术要点

#### 7.2.1 微信开放平台配置

```
网站应用配置：
├── 应用名称: 年会签到系统
├── 应用官网: https://your-domain.com
├── 授权回调域: your-domain.com
└── 获取参数:
    ├── AppID: wx1234567890
    └── AppSecret: xxxxxxxxxxxxxxxx
```

#### 7.2.2 OAuth 授权 URL 格式

```
https://open.weixin.qq.com/connect/qrconnect
  ?appid=APPID
  &redirect_uri=REDIRECT_URI
  &response_type=code
  &scope=snsapi_login
  &state=STATE
#wechat_redirect
```

#### 7.2.3 获取用户信息流程

```
1. 用户扫码授权后，回调获取 code
2. 使用 code 换取 access_token 和 openid：
   GET https://api.weixin.qq.com/sns/oauth2/access_token
     ?appid=APPID
     &secret=SECRET
     &code=CODE
     &grant_type=authorization_code

3. 获取用户信息（如需昵称头像）：
   GET https://api.weixin.qq.com/sns/userinfo
     ?access_token=ACCESS_TOKEN
     &openid=OPENID
```

---

## 附录

### A. 微信开放平台参考文档

- [微信开放平台](https://open.weixin.qq.com/)
- [网站应用微信登录开发指南](https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html)
- [获取用户个人信息](https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Authorized_Interface_Calling_UnionID.html)

### B. 与现有系统的兼容性

微信登录方案可以与现有的抽奖系统完美集成：

1. **参与者名单**：复用现有 participants 数据
2. **签到记录**：使用相同的 check_ins 表结构
3. **大屏展示**：无需任何修改
4. **抽奖联动**：保持不变

---

_文档结束_
